# GitHub Actions CI/CD Workflow for Cloud Deployment
# File location: .github/workflows/deploy-cloud.yml

name: Build and Deploy to Cloud

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Allow manual trigger

env:
  DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
  BACKEND_IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/todo-backend
  FRONTEND_IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/todo-frontend

jobs:
  build-backend:
    name: Build Backend Image
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push backend image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./docker/backend/Dockerfile
          push: true
          tags: |
            ${{ env.BACKEND_IMAGE }}:latest
            ${{ env.BACKEND_IMAGE }}:${{ github.sha }}
          cache-from: type=registry,ref=${{ env.BACKEND_IMAGE }}:latest
          cache-to: type=inline

  build-frontend:
    name: Build Frontend Image
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./docker/frontend/Dockerfile
          push: true
          tags: |
            ${{ env.FRONTEND_IMAGE }}:latest
            ${{ env.FRONTEND_IMAGE }}:${{ github.sha }}
          cache-from: type=registry,ref=${{ env.FRONTEND_IMAGE }}:latest
          cache-to: type=inline

  deploy:
    name: Deploy to Cloud Kubernetes
    runs-on: ubuntu-latest
    needs: [build-backend, build-frontend]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'

      - name: Install Helm
        uses: azure/setup-helm@v3
        with:
          version: 'v3.13.0'

      - name: Configure kubectl for OCI
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBECONFIG_CONTENT }}" | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config

      - name: Verify cluster connectivity
        run: |
          kubectl cluster-info
          kubectl get nodes

      - name: Update Helm deployment
        run: |
          helm upgrade --install todo-chatbot ./helm/todo-chatbot /
            --namespace todo-app /
            --create-namespace /
            --set backend.image.repository=${{ env.BACKEND_IMAGE }} /
            --set backend.image.tag=latest /
            --set frontend.image.repository=${{ env.FRONTEND_IMAGE }} /
            --set frontend.image.tag=latest /
            --wait /
            --timeout 10m

      - name: Verify deployment
        run: |
          kubectl rollout status deployment/backend -n todo-app --timeout=5m
          kubectl rollout status deployment/frontend -n todo-app --timeout=5m

      - name: Check pod health
        run: |
          kubectl get pods -n todo-app
          kubectl wait --for=condition=ready pod -l app=backend -n todo-app --timeout=5m
          kubectl wait --for=condition=ready pod -l app=frontend -n todo-app --timeout=5m

      - name: Get LoadBalancer IP
        id: get-ip
        run: |
          EXTERNAL_IP=$(kubectl get svc frontend-service -n todo-app -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
          echo "EXTERNAL_IP=$EXTERNAL_IP" >> $GITHUB_OUTPUT
          echo "Frontend accessible at: http://$EXTERNAL_IP"

      - name: Test health endpoint
        run: |
          BACKEND_POD=$(kubectl get pod -n todo-app -l app=backend -o jsonpath='{.items[0].metadata.name}')
          kubectl exec -n todo-app $BACKEND_POD -- curl -f http://localhost:8000/api/health || exit 1

      - name: Deployment summary
        run: |
          echo "✅ Deployment successful!"
          echo "Backend image: ${{ env.BACKEND_IMAGE }}:latest"
          echo "Frontend image: ${{ env.FRONTEND_IMAGE }}:latest"
          echo "Frontend URL: http://${{ steps.get-ip.outputs.EXTERNAL_IP }}"
          echo "Namespace: todo-app"
          kubectl get all -n todo-app

  rollback:
    name: Rollback on Failure
    runs-on: ubuntu-latest
    needs: deploy
    if: failure()
    steps:
      - name: Configure kubectl
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBECONFIG_CONTENT }}" | base64 -d > $HOME/.kube/config

      - name: Rollback Helm release
        run: |
          helm rollback todo-chatbot -n todo-app
          echo "⚠️ Deployment failed. Rolled back to previous version."

# Required GitHub Secrets:
# - DOCKERHUB_USERNAME: Your Docker Hub username
# - DOCKERHUB_TOKEN: Docker Hub access token
# - KUBECONFIG_CONTENT: Base64-encoded kubeconfig file
#   Generate with: cat ~/.kube/config | base64 -w 0
#
# Optional Secrets (if using OCI CLI instead of kubeconfig):
# - OCI_CLI_USER: OCI user OCID
# - OCI_CLI_TENANCY: OCI tenancy OCID
# - OCI_CLI_FINGERPRINT: API key fingerprint
# - OCI_CLI_KEY_CONTENT: Private key content
# - OCI_CLI_REGION: OCI region (e.g., us-ashburn-1)
